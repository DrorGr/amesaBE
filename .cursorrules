# AmesaBE Project - Backend - Cursor Rules

## Project Overview
AmesaBE is the backend API for the Amesa lottery management system. Built with .NET 8.0 and ASP.NET Core, it provides RESTful APIs, real-time communication via SignalR, and integrates with Aurora PostgreSQL for data persistence.

## Workspace Structure
**âš ï¸ This repository is part of the AmesaBase-Monorepo workspace**
- **Monorepo Root**: `C:\Users\dror0\Curser-Repos\AmesaBase-Monorepo\`
- **Frontend (FE/)**: Angular frontend â†’ https://github.com/DrorGr/amesaFE
- **This Repository (BE/)**: .NET 8.0 backend â†’ https://github.com/DrorGr/amesaBE
- **MetaData/**: Cross-cutting docs, scripts, and configs

## Repository Structure
- **AmesaBackend**: Main .NET 8.0 API project â†’ Docker + ECS
- **AmesaBackend.Tests**: Unit and integration tests
- **AmesaBackend.DatabaseSeeder**: Database seeding tool (excluded from repository, in .gitignore)
- **Related Repos**: amesaFE (Frontend), amesaDevOps (Infrastructure)
- **Scripts**: All SQL and PowerShell scripts in `MetaData/Scripts/` folder

## Technology Stack
- **Backend**: .NET 8.0, ASP.NET Core, Entity Framework Core
- **Admin Panel**: Blazor Server (integrated monolith) âœ… NEW
- **Database**: Aurora PostgreSQL Serverless v2, SQLite (local development)
- **Real-time**: SignalR for live lottery updates
- **Authentication**: JWT Bearer tokens (API), Email/Password (Admin Panel)
- **Payment**: Stripe integration
- **Caching**: Redis (planned)
- **Infrastructure**: AWS (ECS Fargate, ECR, ALB, Aurora)
- **CI/CD**: GitHub Actions
- **Version Control**: Git with GitHub repository
- **Package Management**: NuGet

## Current Status (2025-01-XX)
- **Repository**: https://github.com/DrorGr/amesaBE
- **Main branch**: Stable, deployed with Lottery Favorites Phase 1 âœ…
- **Admin Panel**: Blazor Server admin panel deployed to production âœ…
- **Database**: Fully seeded with comprehensive test data âœ…
- **Translations**: 4 languages supported (EN, ES, FR, PL) - 507 keys each âœ…
- **User Preferences**: Complete CRUD API implemented âœ…
- **Lottery Favorites**: Phase 1 complete, deployed to production âœ…
- **Deployment**: ECS Fargate with Docker containers
- **Latest**: Docker build fix for amesa-lottery-service, production deployment complete
- **Database Seeder**: Excluded from repository (in .gitignore) âœ…

## Environment Configuration

### Local Development
- **Backend**: http://localhost:5000
- **Database**: SQLite (AmesaDB.db) or local PostgreSQL
- **Admin Panel**: http://localhost:5000/admin
- **Configuration**: `appsettings.Development.json`

### Production Environment
- **ECS Cluster**: Amesa (prod service: amesa-backend-service)
- **Database**: amesadbmain (Aurora PostgreSQL Serverless v2)
- **ALB**: amesa-backend-alb-509078867.eu-north-1.elb.amazonaws.com
- **Admin Panel**: http://amesa-backend-alb-509078867.eu-north-1.elb.amazonaws.com/admin âœ…
- **ECR Image Tag**: prod-{sha}, latest, prod-latest
- **Deployment**: Auto on push to main branch

## AWS Infrastructure
- **Region**: eu-north-1 (Stockholm)
- **Account**: 129394705401
- **ECR Repository**: amesabe
- **ECS Cluster**: Amesa
- **Aurora PostgreSQL**: Serverless v2 production cluster
- **ALB**: Application Load Balancer for production
- **CloudWatch**: Logs and monitoring

## API Structure

### Core Endpoints
- **Health**: `/health` - Service health check
- **Auth**: `/api/v1/auth/*` - Authentication and user management
- **Houses**: `/api/v1/houses/*` - Lottery properties and tickets
- **Translations**: `/api/v1/translations/*` - Internationalization
- **Lottery Results**: `/api/v1/lottery-results/*` - Draw results

### Admin Panel âœ…
- **URL**: `/admin` - Blazor Server admin interface
- **Features**: Houses, Users, Translations, Promotions, Content management
- **Authentication**: Email/password login with session management
- **Documentation**: See `ADMIN_PANEL_GUIDE.md`, `ADMIN_PANEL_DEPLOYED_SUCCESS.md`

### Real-time Hubs (SignalR)
- **LotteryHub**: Live lottery updates, ticket purchases
- **NotificationHub**: Real-time notifications

## Coding Standards

### .NET/C# Best Practices
- Use .NET 8.0 features and patterns
- Follow async/await patterns for all I/O operations
- Implement proper dependency injection
- Use Entity Framework Core with migrations
- Follow RESTful API design principles
- Implement comprehensive error handling
- Use structured logging with Serilog

### API Design
- Versioned endpoints (`/api/v1/`)
- Consistent response format (success/error wrapping)
- Proper HTTP status codes
- Request/response DTOs for all endpoints
- Swagger/OpenAPI documentation
- Input validation with FluentValidation
- Rate limiting and throttling

### Security
- JWT Bearer authentication
- Role-based authorization
- CORS configuration
- Security headers middleware
- Input sanitization
- SQL injection prevention (parameterized queries)
- Secrets management via AWS Secrets Manager

### Database
- PostgreSQL in production (Aurora Serverless v2)
- SQLite for local development
- Entity Framework Core migrations
- Connection pooling and retry logic
- Database seeding for initial data

## Project Structure Guidelines

### Controllers
- Thin controllers, business logic in services
- Action-level authorization attributes
- Comprehensive XML documentation comments
- Proper model validation

### Services
- Interface-based service pattern
- Scoped/Singleton lifetime management
- Async methods for I/O operations
- Dependency injection

### DTOs
- Separate request/response models
- AutoMapper for entity mapping
- Validation attributes

### Middleware
- Error handling middleware (global exception handler)
- Request logging middleware
- Security headers middleware
- Authentication/authorization middleware

## Docker Configuration
- **Base Image**: mcr.microsoft.com/dotnet/aspnet:8.0
- **Port**: 8080 (HTTP)
- **Health Check**: `/health` endpoint
- **Non-root user**: app user for security
- **Multi-stage build**: Separate build and runtime stages

## Deployment Flow

### Automatic Deployment
1. **Main Branch** â†’ Push â†’ GitHub Actions â†’ ECR â†’ ECS Production

### GitHub Secrets Required
- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`
- `PROD_ECS_CLUSTER`, `PROD_ECS_SERVICE`
- `PROD_DB_CONNECTION_STRING`
- `PROD_JWT_SECRET_KEY`

## Common Commands

### Local Development
```bash
# Restore dependencies
dotnet restore

# Build solution
dotnet build

# Run tests
dotnet test

# Run application
dotnet run --project AmesaBackend

# Run with database seeding
dotnet run --project AmesaBackend -- --seeder

# Watch mode (auto-reload)
dotnet watch run --project AmesaBackend
```

### Database Operations
```bash
# Add migration
dotnet ef migrations add MigrationName --project AmesaBackend

# Update database
dotnet ef database update --project AmesaBackend

# Rollback migration
dotnet ef database update PreviousMigrationName --project AmesaBackend

# Generate SQL script
dotnet ef migrations script --project AmesaBackend
```

### Docker Operations
```bash
# Build Docker image
docker build -t amesa-backend:dev ./AmesaBackend

# Run Docker container
docker run -p 8080:8080 amesa-backend:dev

# Docker Compose (development)
docker-compose -f docker-compose.dev.yml up

# Docker Compose (production-like)
docker-compose up
```

### AWS Operations
```bash
# List ECS services
aws ecs list-services --cluster Amesa --region eu-north-1

# Describe ECS service
aws ecs describe-services --cluster Amesa --services amesa-backend-service --region eu-north-1

# View service logs
aws logs tail /ecs/amesa-backend --follow --region eu-north-1

# List ECR images
aws ecr describe-images --repository-name amesabe --region eu-north-1

# Database cluster info
aws rds describe-db-clusters --db-cluster-identifier amesadbmain --region eu-north-1
```

### Git Operations
```bash
# Check status
git status

# View recent commits
git log --oneline -5

# Switch to main branch
git checkout main
```

## Context Files to Maintain

### In This Repository (BE/):
- `CONTEXT_QUICK_REFERENCE.md` - Backend quick reference
- `CURRENT_WORK.md` - Backend current tasks and status
- `CURRENT_STATUS_SUMMARY.md` - Backend latest status overview
- `DEPLOYMENT_STATUS_REPORT.md` - Backend deployment status
- `TROUBLESHOOTING.md` - Backend troubleshooting
- `API-Design.md` - API endpoint documentation
- `README.md` - Project documentation

### In Monorepo MetaData/ (Cross-cutting):
- `../MetaData/Documentation/AWS_INFRASTRUCTURE_DETAILS.md` - Infrastructure details
- `../MetaData/Documentation/ENVIRONMENT_URLS_REFERENCE.md` - Comprehensive URLs
- `../MetaData/Reference/ENVIRONMENT_URLS_GRID.csv` - CSV for team sharing
- `../MetaData/Scripts/` - Deployment and utility scripts
- `../MetaData/Configs/` - ECS task definitions and configs

## Agent Instructions

### ğŸš€ **ON AGENT CREATION - MANDATORY FIRST STEPS**
**CRITICAL**: When a new agent session starts, you MUST:
1. **Read and review ALL context files** to understand current backend state:
   - Read `.cursorrules` (root monorepo context)
   - Read `BE/.cursorrules` (this file - backend context)
   - Review `MetaData/Documentation/` for recent session documentation
   - Check "Recent Changes" and "Recent Major Work" sections
2. **Understand current backend status** before starting any work:
   - Review "Current Status" section
   - Check deployment status and environment configuration
   - Review API structure and endpoints
   - Identify any ongoing work or pending tasks
   - Note any known issues or limitations
3. **Familiarize yourself with backend architecture**:
   - Understand .NET 8.0 project structure
   - Know database schema and Entity Framework setup
   - Understand deployment process (ECS, Docker, ECR)
   - Review AWS infrastructure configuration

### ğŸ“‹ **General Agent Guidelines**
- Always check context files for current project status
- Follow .NET 8.0 and ASP.NET Core best practices
- Maintain RESTful API design principles
- Document API changes in Swagger/OpenAPI
- Test changes with unit and integration tests
- Ensure database migrations are properly created

### âœ… **TASK COMPLETION PROTOCOL - MANDATORY**
**CRITICAL**: For every task you start and complete, you MUST:
1. **Use `todo_write` tool** to track all tasks with clear status updates
2. **BUILD LOCALLY BEFORE PUSHING** - **MANDATORY**:
   - **ALWAYS run `dotnet build`** in the BE directory before committing/pushing
   - Verify build completes successfully with no errors
   - Run tests if applicable: `dotnet test`
   - Fix any build errors before pushing to repository
   - This prevents CI/CD failures and broken deployments
3. **Update context files IMMEDIATELY upon task completion**:
   - Update `BE/.cursorrules` "Recent Major Work" section
   - Update root `.cursorrules` "Recent Changes" section
   - Update `CONTEXT_QUICK_REFERENCE.md` if applicable
   - Document in "Recent Major Work" with:
     - âœ… Status indicators
     - Clear descriptions of what was fixed/implemented
     - Technical details for future reference
     - Date and session information
4. **Commit context updates** to the BE repository:
   - All backend context updates â†’ commit to BE repository
   - Include context updates in the same commit as code changes when possible
5. **Provide summary** of what was accomplished for chat continuity

**Why This Matters**: This ensures that when a new agent session starts, the context contains complete, up-to-date information about recent backend work and current status. Without updating context files, new agents will be working with outdated information.

### ğŸ”§ **CRITICAL UPDATE TRIGGERS**
**CRITICAL**: If any changes relate to the following, you MUST update context files:
- API design or endpoint changes
- Database schema or migrations
- Deployment processes or infrastructure
- Environment configuration
- Authentication/authorization changes
- New features or major refactoring

## Architecture Overview

### System Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚â”€â”€â”€â–¶â”‚     Backend      â”‚â”€â”€â”€â–¶â”‚    Database     â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ Angular 20.2.1  â”‚    â”‚ .NET 8.0         â”‚    â”‚ Aurora PostgreSQLâ”‚
â”‚ S3 + CloudFront â”‚    â”‚ ECS Fargate      â”‚    â”‚ Serverless v2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Docker + ALB     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ SignalR Hubs     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Request Flow
```
Client â†’ CloudFront /api/* â†’ ALB â†’ ECS Task â†’ .NET API â†’ Aurora PostgreSQL
                                              â†’ SignalR Hub â†’ WebSocket Connection
```

## Business Context
- **4Wins Model**: Property lottery platform
- **Legal Compliance**: Gaming regulations, responsible gambling
- **Payment Processing**: Secure Stripe integration
- **Multi-language**: Internationalization support
- **Real-time Features**: Live lottery updates via SignalR
- **Identity Verification**: KYC/AML compliance

## Recent Major Work (2025-01-XX) - LOTTERY FAVORITES DEPLOYMENT & DOCKER BUILD FIX
- âœ… **Docker Build Error Fixed** - Resolved NETSDK1152 error for amesa-lottery-service
- âœ… **Dockerfile Workaround** - Added temporary rename of Auth appsettings.json during publish
- âœ… **Project Reference Updated** - Modified AmesaBackend.Lottery.csproj to handle referenced project content
- âœ… **Backend Deployed** - Lottery Favorites Phase 1 code deployed to production via CI/CD
- âœ… **Production Test Script** - Created PowerShell script for testing endpoints on production
- âœ… **Migration Complete** - Database indexes, views, and translations added to production
- âœ… **Ready for Testing** - All services deployed, endpoints ready for production verification

## Previous Major Work (2025-11-21) - COMPLETE TRANSLATION SYSTEM OVERHAUL
- âœ… **Complete Translation Coverage** - All 507 frontend translation keys identified and scripted
- âœ… **Language Support Reduced** - Removed Hebrew and Arabic, now 4 languages (EN, ES, FR, PL)
- âœ… **Comprehensive SQL Script** - `COMPLETE_ALL_507_TRANSLATIONS.sql` with all keys for all languages
- âœ… **Script Organization** - All SQL scripts moved to `MetaData/Scripts/` folder
- âœ… **Database Seeder Excluded** - Seeder service added to .gitignore, removed from repository
- âœ… **Translation Loader** - Enhanced UX with loader when switching languages

## Previous Major Work (2025-11-21) - DATABASE SEEDING & TRANSLATION FIXES
- âœ… **Database Fully Seeded** - Production database populated with comprehensive test data
- âœ… **Translation System Fixed** - Resolved Entity Framework schema mapping issues  
- âœ… **Polish Language Added** - Complete Polish translation support (6th language)
- âœ… **User Preferences API** - Full CRUD implementation with JSONB storage
- âœ… **Schema Alignment** - EF models now match actual database schemas
- âœ… **Safety Measures** - Prevented data loss with proper conflict handling
- âœ… **Database Seeder** - Production-safe comprehensive data population tool (now excluded from repo)

## Previous Work (2025-10-08)
- âœ… Configured GitHub Actions CI/CD pipeline
- âœ… Set up ECS/ECR deployment flow
- âœ… Implemented multi-environment strategy
- âœ… Added health check endpoints
- âœ… Configured database authentication

## ğŸ“š **Session Documentation**
**Latest Session**: [Database Seeding & Translation System Fix](../MetaData/Documentation/2025-11-21-Database-Seeding-And-Translations/README.md)
- Complete handoff documentation
- Technical implementation details
- Schema reference files
- Safety measures and validation

---
**Last Updated**: 2025-11-21
**Note**: This file should be updated whenever API design, database schema, deployment processes, or infrastructure changes.

